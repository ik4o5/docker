# Thanks to @kangwonlee for showing how to test on travis with windows using conda
# https://github.com/kangwonlee/travis-yml-conda-posix-nt/blob/master/.travis.yml


language : shell

env:
  - CONDA_PYTHON=3.4
  - CONDA_PYTHON=3.5
  - CONDA_PYTHON=3.6
  - CONDA_PYTHON=3.7

os:
  - windows
  - linux

before_install:
  # set conda path info
  - if [[ "$TRAVIS_OS_NAME" != "windows" ]]; then
      MINICONDA_PATH=$HOME/miniconda;
      MINICONDA_SUB_PATH=$MINICONDA_PATH/bin;
      EGOIOCONFIGDIR=$HOME/.egoio;
    elif [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
      MINICONDA_PATH=/c/tools/miniconda3/;
      MINICONDA_PATH_WIN=`cygpath --windows $MINICONDA_PATH`;
      MINICONDA_SUB_PATH=$MINICONDA_PATH/Scripts;
      EGOIOCONFIGDIR=$USERPROFILE/.egoio;
    fi;

  # obtain miniconda installer
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
    elif  [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      wget https://repo.continuum.io/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O miniconda.sh;
    fi;
  - echo "$MINICONDA_PATH"; echo "$MINICONDA_SUB_PATH";

install:
  # install miniconda
  # pip and conda will also need OpenSSL for Windows
  - if [[ "$TRAVIS_OS_NAME" != "windows" ]]; then
      bash miniconda.sh -b -p $HOME/miniconda;
    elif  [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
      choco install openssl.light;
      choco install miniconda3 --params="'/AddToPath:1 /D:$MINICONDA_PATH_WIN'";
    fi;
  - export PATH="$MINICONDA_PATH:$MINICONDA_SUB_PATH:$PATH";

  # for conda version 4.4 or later
  - source $MINICONDA_PATH/etc/profile.d/conda.sh;
  - hash -r;
  - conda config --set always_yes yes --set changeps1 no;
  - conda update -q conda;
  - echo "Python $CONDA_PYTHON running on $TRAVIS_OS_NAME";
  - if [[ "$TRAVIS_OS_NAME" != "windows" ]]; then
      conda create --name ding0_env python=$CONDA_PYTHON --file=ding0_env.yml;
    elif  [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
      conda env create --name ding0_env python=$CONDA_PYTHON;
      conda env update -n ding0_env --file=ding0_env.yml;
    fi;
  - which pip; which python; pip -V; python -V; which pip3; which python3;
  #- conda activate test-environment;
  - source activate ding0_env
  - which pip; which python; pip -V; python -V; which pip3; which python3;

  # Create config file for database access
  - mkdir $EGOIOCONFIGDIR
  - printf '%s\n' '[oedb]' 'dialect = oedialect' 'host = openenergy-platform.org' 'port = 443' 'database = oedb' 'username = Ding0_test_user' 'password = 659193bb5925d401943e4f77d4bac7479bcd9214'> $EGOIOCONFIGDIR/config.ini
  - cat $EGOIOCONFIGDIR/config.ini
  - pip install --no-cache-dir .

  # List installed packages for debugging
  - conda list
  - pip list

script:
  pytest -vv
